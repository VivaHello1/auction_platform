name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_DB: autobid_test
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
    - uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.13'

    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: latest
        virtualenvs-create: true
        virtualenvs-in-project: true

    - name: Load cached venv
      id: cached-poetry-dependencies
      uses: actions/cache@v4
      with:
        path: .venv
        key: venv-${{ runner.os }}-${{ steps.setup-python.outputs.python-version }}-${{ hashFiles('**/poetry.lock') }}

    - name: Install dependencies
      if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
      run: poetry install --no-interaction --no-root

    - name: Run migrations
      run: poetry run alembic upgrade head
      env:
        POSTGRES_HOST: localhost
        POSTGRES_USER: postgres
        POSTGRES_SCHEMA: api_test
        POSTGRES_PASSWORD: postgres
        POSTGRES_DB: autobid_test

    - name: Run tests
      run: poetry run pytest
      env:
        POSTGRES_HOST: localhost
        POSTGRES_USER: postgres
        POSTGRES_SCHEMA: api_test
        POSTGRES_PASSWORD: postgres
        POSTGRES_DB: autobid_test

    - name: Run formatting check
      run: |
        poetry run black --check .
        poetry run isort --check-only .

    - name: Run linting
      run: poetry run ruff check .

    - name: Cleanup test artifacts
      if: always()
      run: |
        # Remove test databases and temporary files
        rm -rf .pytest_cache/
        rm -rf .coverage
        rm -rf htmlcov/
        rm -rf .ruff_cache/
        # Clean up any test logs
        find . -name "*.log" -type f -delete
        # Clean up any temporary migration files
        find . -name "*.pyc" -type f -delete
        find . -name "__pycache__" -type d -exec rm -rf {} + 2>/dev/null || true

    - name: Upload test results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: |
          pytest-results.xml
          coverage.xml
        retention-days: 30
      continue-on-error: true

    - name: Display job status
      if: always()
      run: |
        echo "Job completed with status: ${{ job.status }}"
        if [ "${{ job.status }}" != "success" ]; then
          echo "Some steps failed. Check the logs above for details."
        fi
